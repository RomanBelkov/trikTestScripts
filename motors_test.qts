var m1 = brick.motor("M1");
var m2 = brick.motor("M2");
var m3 = brick.motor("M3");
var m4 = brick.motor("M4");
var e1 = brick.encoder("B1");
var e2 = brick.encoder("B2");
var e3 = brick.encoder("B3");
var e4 = brick.encoder("B4");

var power = 100;
var ed1old=0;
var ed2old=0;
var ed3old=0;
var ed4old=0;

var ed1new=0;
var ed2new=0;
var ed3new=0;
var ed4new=0;

e1.reset();
e2.reset();
e3.reset();
e4.reset();

var i = 0;
var period = 500;
var motorCoeff = 9*period/1000;

var setLabel = function(_text, _x, _y) {
  brick.display().setPainterColor("black");
  brick.display().addLabel(_text, _x, _y);
}

var setColoredRect = function(_rpm, _w, _h, _x , _y) {
  
  rpm = Math.abs(_rpm);

  if(rpm == 0) {
    print("gray");
    brick.display().setPainterColor("gray");
  } else if ((rpm > 85) && (rpm <= 120)) {
    print("green");
    brick.display().setPainterColor("green");
  } else if ((rpm > 55) && (rpm <= 85)) {
    print("yellow");
    brick.display().setPainterColor("yellow");
  } else {
    print("red");
    brick.display().setPainterColor("red");
  } 
  
//  brick.display().setPainterColor("gray");
  brick.display().setPainterWidth(20); 
  brick.display().drawRect(_w, _h, _x, _y);
}

while(1) {
  ed1new=e1.readRawData();
  ed2new=e2.readRawData();
  ed3new=e3.readRawData();
  ed4new=e4.readRawData();

  if(i == 0) {

    power*=-1;         
    m1.setPower(power);  
    m2.setPower(power);  
    m3.setPower(power);  
    m4.setPower(power); 
  }
  i = (i + 1) % 6;

  var ed1 = Math.round((ed1new - ed1old)/motorCoeff);
  var ed2 = Math.round((ed2new - ed2old)/motorCoeff);
  var ed3 = Math.round((ed3new - ed3old)/motorCoeff);
  var ed4 = Math.round((ed4new - ed4old)/motorCoeff);

  brick.display().clear();
  //M1
  setLabel("{0}\n".format(ed1),30,30);
  setColoredRect(ed1, 20, 20, 70, 50);
  //M2
  setLabel("{0}\n".format(ed2),140+10,30);
  setColoredRect(ed2, 140, 20, 70, 50);
  //M3
  setLabel("{0}\n".format(ed3),30,210+10);
  setColoredRect(ed3, 20, 210, 70, 50);
  //M4
  setLabel("{0}\n".format(ed4),140+10,210+10);
  setColoredRect(ed4, 140, 210, 70, 50);

  ed1old = e1.readRawData();
  ed2old = e2.readRawData();
  ed3old = e3.readRawData();
  ed4old = e4.readRawData();

  script.wait(period);
}

script.run();
